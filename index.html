<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Chamada - Inglês</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
</head>
<body class="bg-light">

<div class="container my-4" id="loginContainer">
  <h2>Login</h2>
  <input type="text" id="loginUsuario" class="form-control mb-2" placeholder="Usuário" />
  <input type="password" id="loginSenha" class="form-control mb-2" placeholder="Senha" />
  <button class="btn btn-primary" onclick="fazerLogin()">Entrar</button>
</div>

<div class="container my-4 d-none" id="mainContainer">
  <h2>Sistema de Chamada</h2>
  <p>Usuário logado: <span id="usuarioAtual"></span> (<span id="tipoUsuarioAtual"></span>)</p>
  <button class="btn btn-secondary btn-sm mb-3" onclick="logout()">Sair</button>

  <div id="adminPanel" class="mb-4 d-none">
    <h4>Cadastro de Usuário</h4>
    <input type="text" id="novoUsuario" class="form-control mb-2" placeholder="Nome de usuário" />
    <input type="password" id="novaSenha" class="form-control mb-2" placeholder="Senha" />
    <select id="tipoUsuario" class="form-select mb-2">
      <option value="professor">Professor</option>
      <option value="admin">Admin</option>
    </select>
    <button class="btn btn-success mb-2" onclick="cadastrarUsuario()">Cadastrar Usuário</button>

    <h4>Lista de Usuários</h4>
    <ul id="listaUsuarios" class="list-group mb-3"></ul>
  </div>

  <div id="professorPanel">
    <h4>Cadastro de Aluno</h4>
    <input type="text" id="nomeAluno" class="form-control mb-2" placeholder="Nome do Aluno" />
    <button class="btn btn-primary mb-2" onclick="adicionarAluno()">Adicionar Aluno</button>

    <h4>Chamada</h4>
    <textarea id="conteudoAula" class="form-control mb-2" placeholder="Conteúdo da aula de hoje"></textarea>
    <ul id="listaAlunos" class="list-group mb-2"></ul>
    <button class="btn btn-success" onclick="registrarChamada()">Registrar Chamada</button>
  </div>

  <h4 class="mt-4">Histórico de Chamadas</h4>
  <ul id="historicoChamadas" class="list-group"></ul>
</div>

<script>
  let usuarios = JSON.parse(localStorage.getItem("usuarios"));
  if (!Array.isArray(usuarios)) {
      usuarios = [{
          nome: "Administrador",
          usuario: "admin",
          senha: "admin",
          tipo: "admin"
      }];
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
  }
let chamadas = JSON.parse(localStorage.getItem('chamadas')) || [];
let usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));

function salvarUsuarios() {
  localStorage.setItem('usuarios', JSON.stringify(usuarios));
}

function salvarChamadas() {
  localStorage.setItem('chamadas', JSON.stringify(chamadas));
}

function fazerLogin() {
  const usuario = document.getElementById('loginUsuario').value;
  const senha = document.getElementById('loginSenha').value;
  const encontrado = usuarios.find(u => u.usuario === usuario && u.senha === senha);
  if (encontrado) {
    usuarioLogado = encontrado;
    localStorage.setItem('usuarioLogado', JSON.stringify(encontrado));
    carregarTela();
  } else {
    alert('Usuário ou senha incorretos.');
  }
}

function logout() {
  usuarioLogado = null;
  localStorage.removeItem('usuarioLogado');
  location.reload();
}

function carregarTela() {
  document.getElementById('loginContainer').classList.add('d-none');
  document.getElementById('mainContainer').classList.remove('d-none');
  document.getElementById('usuarioAtual').textContent = usuarioLogado.usuario;
  document.getElementById('tipoUsuarioAtual').textContent = usuarioLogado.tipo;

  if (usuarioLogado.tipo === 'admin') {
    document.getElementById('adminPanel').classList.remove('d-none');
    document.getElementById('professorPanel').classList.add('d-none');
    atualizarListaUsuarios();
  } else {
    document.getElementById('adminPanel').classList.add('d-none');
    document.getElementById('professorPanel').classList.remove('d-none');
    atualizarListaAlunos();
  }

  atualizarHistoricoChamadas();
}

function cadastrarUsuario() {
  const usuario = document.getElementById('novoUsuario').value;
  const senha = document.getElementById('novaSenha').value;
  const tipo = document.getElementById('tipoUsuario').value;
  if (usuario && senha) {
    usuarios.push({ usuario, senha, tipo });
    salvarUsuarios();
    atualizarListaUsuarios();
  }
}

function atualizarListaUsuarios() {
  const lista = document.getElementById('listaUsuarios');
  lista.innerHTML = '';
  usuarios.forEach((u, index) => {
    const item = document.createElement('li');
    item.className = 'list-group-item d-flex justify-content-between align-items-center';
    item.innerHTML = `
      ${u.usuario} (${u.tipo})
      <button class="btn btn-danger btn-sm" onclick="removerUsuario(${index})">Excluir</button>
    `;
    lista.appendChild(item);
  });
}

function removerUsuario(index) {
  usuarios.splice(index, 1);
  salvarUsuarios();
  atualizarListaUsuarios();
}

function adicionarAluno() {
  const nome = document.getElementById('nomeAluno').value;
  if (!nome) return;
  let alunos = JSON.parse(localStorage.getItem('alunos_' + usuarioLogado.usuario)) || [];
  alunos.push({ nome });
  localStorage.setItem('alunos_' + usuarioLogado.usuario, JSON.stringify(alunos));
  atualizarListaAlunos();
  document.getElementById('nomeAluno').value = '';
}

function atualizarListaAlunos() {
  const lista = document.getElementById('listaAlunos');
  lista.innerHTML = '';
  const alunos = JSON.parse(localStorage.getItem('alunos_' + usuarioLogado.usuario)) || [];
  alunos.forEach((aluno, i) => {
    const item = document.createElement('li');
    item.className = 'list-group-item';
    item.innerHTML = `
      <input type="checkbox" id="aluno_${i}" class="form-check-input me-2">
      ${aluno.nome}
    `;
    lista.appendChild(item);
  });
}

function registrarChamada() {
  const alunos = JSON.parse(localStorage.getItem('alunos_' + usuarioLogado.usuario)) || [];
  const presentes = [];
  alunos.forEach((aluno, i) => {
    const presente = document.getElementById(`aluno_${i}`).checked;
    presentes.push({ nome: aluno.nome, presente });
  });
  const conteudo = document.getElementById('conteudoAula').value;
  const chamada = {
    professor: usuarioLogado.usuario,
    data: new Date().toLocaleString(),
    conteudo,
    presencas: presentes
  };
  chamadas.push(chamada);
  salvarChamadas();
  atualizarHistoricoChamadas();
  document.getElementById('conteudoAula').value = '';
}

function atualizarHistoricoChamadas() {
  const lista = document.getElementById('historicoChamadas');
  lista.innerHTML = '';
  const minhasChamadas = chamadas.filter(c => c.professor === usuarioLogado?.usuario || usuarioLogado?.tipo === 'admin');
  minhasChamadas.reverse().forEach(c => {
    const item = document.createElement('li');
    item.className = 'list-group-item';
    item.innerHTML = `
      <strong>${c.data}</strong> - Prof: ${c.professor}<br/>
      <em>${c.conteudo}</em><br/>
      ${c.presencas.map(p => `${p.nome}: ${p.presente ? 'Presente' : 'Faltou'}`).join('<br/>')}
    `;
    lista.appendChild(item);
  });
}

if (usuarioLogado) {
  carregarTela();
}
</script>
</body>
</html>