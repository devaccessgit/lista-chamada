<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Chamada - Painel do Professor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <style>
    body {
      padding: 20px;
    }
    .dark-mode {
      background-color: #121212;
      color: white;
    }
    .table-responsive {
      margin-top: 20px;
    }
    .btn-group {
      margin-bottom: 10px;
    }
    #langSelector {
      width: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 data-i18n="title">Painel do Professor</h2>
      <div>
        <select id="langSelector" class="form-select form-select-sm d-inline w-auto" onchange="changeLanguage(this.value)">
          <option value="pt">🇧🇷 Português</option>
          <option value="en">🇺🇸 English</option>
        </select>
        <button id="btnLogout" class="btn btn-danger ms-2" data-i18n="logout">Sair</button>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" onclick="exportarWhatsApp()" data-i18n="sendWhatsApp">📤 Enviar por WhatsApp</button>
      <button class="btn btn-primary" onclick="exportarPDF()" data-i18n="exportPDF">Exportar PDF</button>
      <button class="btn btn-secondary" onclick="exportarCSV()" data-i18n="exportCSV">Exportar CSV</button>
    </div>

    <div id="painelChamada">
      <p><strong data-i18n="teacher">Professor:</strong> <span id="professorLogado"></span></p>

      <form id="formAluno" class="row g-2 mb-3">
        <div class="col-md-6">
          <input type="text" id="nomeAluno" class="form-control" data-i18n-placeholder="studentName" required />
        </div>
        <div class="col-md-6">
          <button type="submit" class="btn btn-success" data-i18n="addStudent">Adicionar Aluno</button>
        </div>
      </form>

      <div class="mb-3">
        <input type="text" id="filtroAluno" class="form-control" data-i18n-placeholder="searchStudent" oninput="filtrarAlunos()" />
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th data-i18n="student">Aluno</th>
              <th data-i18n="present">Presente</th>
            </tr>
          </thead>
          <tbody id="listaAlunos"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const formAluno = document.getElementById("formAluno");
    const nomeAluno = document.getElementById("nomeAluno");
    const listaAlunos = document.getElementById("listaAlunos");
    const professorLogado = document.getElementById("professorLogado");

    const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado")) || { tipo: "", nome: "" };
    professorLogado.innerText = usuarioLogado.nome;

    let alunos = JSON.parse(localStorage.getItem("alunos_" + usuarioLogado.nome)) || [];

    function salvarAlunos() {
      localStorage.setItem("alunos_" + usuarioLogado.nome, JSON.stringify(alunos));
    }

    function renderizarAlunos() {
      listaAlunos.innerHTML = "";
      alunos.forEach((aluno, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${aluno.nome}</td>
          <td><input type="checkbox" ${aluno.presente ? "checked" : ""} onchange="togglePresenca(${index})"></td>
        `;
        listaAlunos.appendChild(row);
      });
    }

    function togglePresenca(index) {
      alunos[index].presente = !alunos[index].presente;
      salvarAlunos();
    }

    formAluno.addEventListener("submit", (e) => {
      e.preventDefault();
      alunos.push({ nome: nomeAluno.value.trim(), presente: false });
      salvarAlunos();
      renderizarAlunos();
      nomeAluno.value = "";
    });

    function filtrarAlunos() {
      const filtro = document.getElementById("filtroAluno").value.toLowerCase();
      const linhas = listaAlunos.getElementsByTagName("tr");
      for (let i = 0; i < linhas.length; i++) {
        const nome = linhas[i].getElementsByTagName("td")[0].innerText.toLowerCase();
        linhas[i].style.display = nome.includes(filtro) ? "" : "none";
      }
    }

    function exportarPDF() {
      const doc = new jspdf.jsPDF();
      let y = 10;
      doc.text(i18n[currentLang].attendanceList, 10, y);
      y += 10;
      alunos.forEach((aluno) => {
        doc.text(`${aluno.nome} - ${aluno.presente ? i18n[currentLang].present : i18n[currentLang].absent}`, 10, y);
        y += 10;
      });
      doc.save("chamada.pdf");
    }

    function exportarCSV() {
      let csv = `${i18n[currentLang].student},${i18n[currentLang].presence}\n`;
      alunos.forEach((aluno) => {
        csv += `"${aluno.nome}","${aluno.presente ? i18n[currentLang].present : i18n[currentLang].absent}"\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "chamada.csv";
      a.click();
    }

    function exportarWhatsApp() {
      let mensagem = `📋 *${i18n[currentLang].attendanceList}* - ${usuarioLogado.nome}\n\n`;
      alunos.forEach((aluno) => {
        mensagem += `• ${aluno.nome}: ${aluno.presente ? "✅ " + i18n[currentLang].present : "❌ " + i18n[currentLang].absent}\n`;
      });
      const url = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
      window.open(url, "_blank");
    }

    document.getElementById("btnLogout").addEventListener("click", () => {
      localStorage.removeItem("usuarioLogado");
      window.location.href = "login.html";
    });

    renderizarAlunos();

    // Tradução
    const i18n = {
      pt: {
        title: "Painel do Professor",
        logout: "Sair",
        sendWhatsApp: "📤 Enviar por WhatsApp",
        exportPDF: "Exportar PDF",
        exportCSV: "Exportar CSV",
        teacher: "Professor:",
        studentName: "Nome do Aluno",
        addStudent: "Adicionar Aluno",
        searchStudent: "Buscar aluno...",
        student: "Aluno",
        present: "Presente",
        absent: "Ausente",
        presence: "Presença",
        attendanceList: "Lista de Presença"
      },
      en: {
        title: "Teacher Panel",
        logout: "Logout",
        sendWhatsApp: "📤 Send via WhatsApp",
        exportPDF: "Export PDF",
        exportCSV: "Export CSV",
        teacher: "Teacher:",
        studentName: "Student Name",
        addStudent: "Add Student",
        searchStudent: "Search student...",
        student: "Student",
        present: "Present",
        absent: "Absent",
        presence: "Presence",
        attendanceList: "Attendance List"
      }
    };

    let currentLang = "pt";

    function translatePage() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        el.innerText = i18n[currentLang][key] || key;
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        el.placeholder = i18n[currentLang][key] || key;
      });
    }

    function changeLanguage(lang) {
      currentLang = lang;
      translatePage();
    }

    // Inicia com o idioma padrão
    translatePage();
  </script>
</body>
</html>